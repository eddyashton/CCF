steps:
- checkout: self
  clean: true
  submodules: true

- task: CMake@1
  displayName: CMake
  inputs:
    cmakeArgs: '-GNinja -DPBFT=ON ..'

- script: ninja
  displayName: Ninja
  workingDirectory: build

# TODO(#pbft): When pbft works with real enclave and dynamically supports
# more than 2 nodes, TEST_ENCLAVE=virtual and -R end_to_end_logging should be removed
- script: |
    python3.7 -m venv env
    source env/bin/activate
    pip install -U -r ../tests/requirements.txt
    TEST_ENCLAVE=virtual ctest -VV -R end_to_end_logging --timeout 240 --no-compress-output -T Test
  displayName: CTest
  workingDirectory: build